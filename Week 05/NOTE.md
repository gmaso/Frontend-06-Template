# ç¬¬äº”å‘¨å­¦ä¹ ç¬”è®°

## 20201127 Proxy ä¸ Reflect
### ä»‹ç»
ä»£ç†ä¸åå°„æ˜¯ ES6 æ–°å¢çš„èƒ½åŠ›ï¼Œå¯ä»¥è®©å¼€å‘è€…æ‹¦æˆªå¹¶å‘åŸºæœ¬æ“ä½œåµŒå…¥é¢å¤–è¡Œä¸ºã€‚

å…·ä½“ä½¿ç”¨æ˜¯ç”¨ä¸€ä¸ªä»£ç†å¯¹è±¡å…³è”ç›®æ ‡å¯¹è±¡ï¼Œç„¶ååœ¨ä¹‹åå°±å¯ä»¥æŠŠè¿™ä¸ªä»£ç†å¯¹è±¡ä½œä¸ºæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡æ¥ä½¿ç”¨ã€‚åœ¨å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œä»»ä½•æ“ä½œå‰ï¼Œéƒ½å¯ä»¥åœ¨ä»£ç†å¯¹è±¡ä¸Šè¿›è¡Œæ§åˆ¶ã€‚ç›´æ¥æ“ä½œç›®æ ‡å¯¹è±¡æ—¶ä¸å—æ§åˆ¶ã€‚

ä»£ç†çš„é—®é¢˜ï¼šProxy æ˜¯ä¸€ç§æ–°çš„åŸºç¡€æ€§è¯­è¨€èƒ½åŠ›ï¼Œæ²¡æ³•è½¬è¯‘æˆ ES5 çš„ä»£ç ï¼Œå› ä¸º Proxy çš„è¡Œä¸ºæ²¡æœ‰å¯ä»¥æ›¿ä»£çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æ³• polyfillã€‚æ‰€ä»¥ï¼ŒProxy åªèƒ½åœ¨ç™¾åˆ†ç™¾æ”¯æŒçš„å¹³å°ä¸Šä½¿ç”¨ã€‚

### åŸºç¡€
ä»£ç†æ˜¯ç›®æ ‡å¯¹è±¡çš„æŠ½è±¡ã€‚

ä»£ç†ä½¿ç”¨ Proxy æ„é€ å‡½æ•°åˆ›å»ºï¼Œå¿…é¡»æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡å’Œå¤„ç†ç¨‹åºå¯¹è±¡ã€‚ç¼ºå°‘ä»»ä¸€ä¸ªä¼šæŠ›å‡º TypeErrorã€‚
```JavaScript
const target = {
  id: 'target'
}
const proxy = new Proxy(target, {})
```
å¤„ç†ç¨‹åºå¯¹è±¡ä¸ºç©ºå¯¹è±¡æ—¶ï¼Œå¯¹ä»£ç†çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šç•…é€šæ— é˜»åœ°ä½œç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¸Šã€‚

ä»£ç†æœ‰ç‚¹ç±»ä¼¼é˜²ç«å¢™ï¼ŒæŠŠç›®æ ‡å¯¹è±¡åŒ…è£¹åœ¨é‡Œè¾¹ï¼Œä»»ä½•è¿›å‡ºé˜²ç«å¢™çš„æ“ä½œéƒ½ä¼šå—åˆ°ç›‘æ§ï¼Œä¹Ÿå¯ä»¥åŠ ä»¥æ§åˆ¶ã€‚

Proxy.prototype æ˜¯ undefinedï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ instanceof æ“ä½œç¬¦ã€‚
```JavaScript
console.log(proxy instanceof Proxy);
// TypeError: Function has non-object prototype 'undefined' in instanceof check;
```

## 20201129
å­¦ä¹  ã€ŠJavaScript é«˜çº§ç¨‹åºè®¾è®¡ã€‹ 4e ç¬¬ 9 ç« ï¼šä»£ç†ä¸åå°„

### æ•è·å™¨
ä½¿ç”¨ä»£ç†çš„ä¸»è¦ç›®çš„æ˜¯å¯ä»¥å®šä¹‰**æ•è·å™¨ï¼ˆtrapï¼‰**ã€‚æ•è·å™¨å°±æ˜¯å¤„ç†ç¨‹åºå¯¹è±¡ä¸­çš„å…ƒç´ ï¼Œæ˜¯â€œåŸºæœ¬æ“ä½œçš„æ‹¦æˆªå™¨â€ã€‚æ¯æ¬¡åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨åŸºæœ¬æ“ä½œæ—¶ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨å¯¹åº”çš„æ•è·å™¨å‡½æ•°ï¼Œç„¶åå†ä½œç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¸Šã€‚
> æ•è·å™¨æ˜¯ä»æ“ä½œç³»ç»Ÿä¸­å€Ÿç”¨çš„æ¦‚å¿µï¼Œè¡¨ç¤ºç¨‹åºæµä¸­çš„ä¸€ä¸ªåŒæ­¥ä¸­æ–­ï¼Œå¯ä»¥æš‚åœç¨‹åºæµï¼Œè½¬è€Œæ‰§è¡Œä¸€æ®µå­ä¾‹ç¨‹ï¼Œä¹‹åå†è¿”å›åŸå§‹ç¨‹åºæµã€‚

### åå°„
æ‰€æœ‰å¯ä»¥æ•è·çš„æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„**åå°„ï¼ˆReflectï¼‰API** æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸æ•è·å™¨æ‹¦æˆªçš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„åç§°å’Œå‡½æ•°ç­¾åï¼Œè€Œä¸”ä¹Ÿå…·æœ‰ä¸è¢«æ‹¦æˆªæ–¹æ³•ç›¸åŒçš„è¡Œä¸ºã€‚

é€šè¿‡ Reflect å¯¹è±¡å¯ä»¥è½»æ¾ç¼–å†™æ•è·å™¨ï¼Œä¸ç”¨å®Œå…¨æ‰‹å†™ã€‚
```JavaScript
// ä»£ç† get
const proxy = new Proxy(target, {
  get() {
    return Reflect.get(...arguments);
  }
});

// ä»£ç† get ç®€å†™
const proxy = new Proxy(target, {
  get: Reflect.get
});

// ç©ºä»£ç†
const proxy = new Proxy(target, Reflect);
```
åå°„ API ä¸ºå¼€å‘è€…å‡†å¤‡å¥½äº†æ ·æœ¬ä»£ç ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥ç”¨æœ€å°‘çš„ä»£ç ä¿®æ”¹æ•è·çš„æ–¹æ³•è¡Œä¸ºã€‚
```JavaScript
// ä¿®æ”¹ get è¿”å›å€¼
const proxy = new Proxy(target, {
  get(trapTarget, property, receiver) {
    let decoration = '';
    if (property === 'foo') {
      decoration = '!!!';
    }
    return Reflect.get(...arguments) + decoration;
  }
});
```

### æ•è·å™¨ä¸å˜å¼ï¼ˆtrap invariantï¼‰
æ•è·å™¨å‡ ä¹å¯ä»¥æ”¹å˜æ‰€æœ‰åŸºæœ¬æ–¹æ³•çš„è¡Œä¸ºï¼Œä½†ä¹Ÿæœ‰é™åˆ¶ã€‚ECMAScript è§„èŒƒè§„å®šæ•è·å™¨çš„è¡Œä¸ºå¿…é¡»éµå¾ªâ€œæ•è·å™¨ä¸å˜å¼â€ã€‚æ•è·å™¨ä¸å˜å¼å› æ•è·çš„æ–¹æ³•ä¸åŒè€Œå¼‚ï¼Œé€šå¸¸é˜²æ­¢æ•è·å™¨å®šä¹‰å‡ºç°è¿‡äºåå¸¸çš„è¡Œä¸ºã€‚

æ¯”å¦‚ï¼Œç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ªä¸å¯é…ç½®ä¸”ä¸å¯å†™çš„æ•°æ®å±æ€§ï¼Œé‚£ä¹ˆæ•è·å™¨è¿”å›ä¸€ä¸ªä¸è¯¥å±æ€§ä¸åŒçš„å€¼æ—¶ï¼Œå°±ä¼šæŠ›å‡º TypeErrorï¼š
```JavaScript
const target = {};
Object.defineProperty(target, 'foo', {
  configurable: false,
  writable: false,
  value: 'bar'
});

const proxy = new Proxy(target, {
  get() {
    return 'qux';
  }
});

console.log(proxy.foo);
// Uncaught TypeError: 'get' on proxy: property 'foo' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected 'bar' but got 'qux')
```

### æ’¤é”€ä»£ç†
ä½¿ç”¨ new Proxy() åˆ›å»ºçš„æ™®é€šä»£ç†ï¼Œä¼šåœ¨ä»£ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†…ä¸€ç›´æŒç»­å­˜åœ¨ã€‚

Proxy ä¹Ÿæš´éœ²äº† revocable() æ–¹æ³•ï¼Œå¯ä»¥æ”¯æŒæ’¤é”€ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡é—´çš„å…³è”ã€‚æ’¤é”€æ“ä½œä¸å¯é€†ã€‚æ’¤é”€æ“ä½œä¹Ÿæ˜¯å¹‚ç­‰çš„ï¼Œè°ƒç”¨å¤šå°‘æ¬¡ç»“æœéƒ½ä¸€æ ·ã€‚

æ’¤é”€æ“ä½œåï¼Œå†è°ƒç”¨ä»£ç†ä¼šæŠ›å‡º TypeErrorã€‚

æ’¤é”€å‡½æ•°ä¸ä»£ç†å¯¹è±¡å†å®ä¾‹åŒ–æ—¶åŒæ—¶ç”Ÿæˆã€‚

```JavaScript
const { proxy, revoke } = Proxy.revocable(target, {});

revoke();

proxy.foo; // Uncaught TypeError: Cannot perform 'get' on a proxy that has been revoked
```

### ä½¿ç”¨åå°„ API
æŸäº›æƒ…å†µä¸‹åº”è¯¥ä¼˜å…ˆä½¿ç”¨åå°„ APIã€‚
1. åå°„ API ä¸å¯¹è±¡ API

   å¤§å¤šæ•°åå°„ API æ–¹æ³•åœ¨ Object ç±»å‹ä¸Šéƒ½æœ‰å¯¹åº”çš„æ–¹æ³•ã€‚é€šå¸¸ï¼ŒObject ä¸Šçš„æ–¹æ³•é€‚ç”¨äºé€šç”¨ç¨‹åºï¼ŒReflect ä¸Šçš„æ–¹æ³•é€‚ç”¨äºç»†ç²’åº¦çš„å¯¹è±¡æ§åˆ¶ä¸æ“ä½œï¼ˆé«˜é˜¶æŠ€èƒ½ğŸ˜€ï¼‰ã€‚
2. çŠ¶æ€æ ‡è®°

   å¾ˆå¤šåå°„æ–¹æ³•è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ‰§è¡Œçš„æ“ä½œæ˜¯å¦æˆåŠŸã€‚æœ‰æ—¶å€™ï¼Œè¿™æ¯”é‚£äº›è¿”å›ä¿®æ”¹åçš„å¯¹è±¡æˆ–è€…æŠ›å‡ºé”™è¯¯çš„åå°„æ–¹æ³•æ›´æœ‰ç”¨ã€‚
3. ç”¨ä¸€ç­‰å‡½æ•°æ›¿ä»£æ“ä½œç¬¦

   ä»¥ä¸‹åå°„æ–¹æ³•æä¾›åªç”¨é€šè¿‡æ“ä½œç¬¦æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š
   - Reflect.get()ï¼šæ›¿ä»£å¯¹è±¡è®¿é—®æ“ä½œç¬¦
   - Reflect.set()ï¼šæ›¿ä»£ = èµ‹å€¼æ“ä½œç¬¦
   - Reflect.has()ï¼šæ›¿ä»£ in æ“ä½œç¬¦æˆ– with()
   - Reflect.deleteProperty()ï¼šæ›¿ä»£ delete æ“ä½œç¬¦
   - Reflect.construct()ï¼šæ›¿ä»£ new æ“ä½œç¬¦
4. å®‰å…¨åœ°åº”ç”¨å‡½æ•°

   æœ‰æ—¶å€™ï¼Œä¸ºäº†é¿å…è°ƒç”¨çš„å‡½æ•°è¡Œä¸ºè¢«ä¿®æ”¹ï¼Œå¯ä»¥ä½¿ç”¨åå°„æ–¹æ³•ã€‚åå°„æ–¹æ³•å°±åƒæ˜¯**ç™¾åˆ†ç™¾åŸç‰ˆçš„çº¯å‡€çš„æ–¹æ³•**ï¼Œä¸ä¼šè¢«ç”¨æˆ·ä¿®æ”¹ã€‚
  ```JavaScript
  Function.prototype.apply.call(myFunc, thisVal, argumentsList);
  // å¯ä¿®æ”¹ä¸º
  Reflect.apply(myFunc, thisVal, argumentsList);
  ```
### ä»£ç†å¦ä¸€ä¸ªä»£ç†
ä»£ç†çš„ç›®æ ‡å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚å¥—å¨ƒã€‚

### ä»£ç†çš„é—®é¢˜ä¸ä¸è¶³
ä½œä¸ºåœ¨ ECMAScript ç°æœ‰åŸºç¡€ä¹‹ä¸Šæ„å»ºèµ·æ¥çš„ä¸€å¥—æ–° APIï¼Œä»£ç†å…¶å®å·²ç»å°½åŠ›åšåˆ°æœ€å¥½äº†ã€‚ï¼ˆ**åˆè¦å…¼å®¹æ—§è§„èŒƒï¼Œåˆè¦å¼•å…¥æ–°ç‰¹æ€§ï¼ŒçœŸçš„å¤ªéš¾äº†ğŸ˜‚**ï¼‰å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä»£ç†ä½œä¸ºå¯¹è±¡çš„è™šæ‹Ÿå±‚å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ä½†æŸäº›æƒ…å†µä¸‹ï¼Œä¹Ÿä¸èƒ½ä¸ç°æœ‰çš„ ECMAScript æœºåˆ¶å¾ˆå¥½åœ°ååŒã€‚
1. ä»£ç†ä¸­çš„ this
2. ä»£ç†ä¸å†…éƒ¨æ§½ä½

### ä»£ç†æ•è·å™¨ä¸åå°„æ–¹æ³•
æ•è·å™¨å¯ä»¥æ•è· 13 ç§ä¸åŒçš„åŸºæœ¬æ“ä½œï¼Œå„è‡ªæœ‰ä¸åŒçš„åå°„ API æ–¹æ³•ã€å‚æ•°ã€å…³è”çš„ ECMAScript æ“ä½œå’Œä¸å˜å¼ã€‚
1. get(target, property, receiver)
2. set(target, property, value, receiver)
3. has(target, property)
4. defineProperty(target, property, descriptor)
5. getOwnPropertyDescriptor(target, property)
6. deleteProperty(target, property)
7. ownKeys(target)
8. getPrototypeOf(target)
9. setPortotypeOf(target, prototype)
10. isExtensible(target)
11. preventExtensions(target)
12. apply(target, thisArg, ...argumentsList)
13. construct(target, argumentsList, newTarget)

