# 第九周学习笔记

## HTML 解析
得到 HTML 主体后，进行解析得到 DOM。

使用状态机（FSM）进行解析。

### HTML 语法
查看 HTML 语言标准 Tokenization 章节，包含所有状态机需要的状态，一共有 80 多个。
Toy Browser 中主要实现 10 多个状态。

解析标签
- 开始标签
- 结束标签
- 自封闭标签

解析属性

#### Tokenization 词法分析



#### 用 token 构建 DOM 树：语法分析
- 从标签构建 DOM 树的基本技巧是使用栈
- 遇到考试标签时，创建元素并入栈，遇到结束标签时出栈
- 自封闭节点可视为入栈后立即出栈（其实就没入栈）
- 任何元素的父元素时它入栈前的栈顶

#### DOM 树添加文本节点
- 文本节点的处理与自封闭标签类似
- 多个连续的文本节点需要合并

### CSS 计算
生成带 CSS 属性的 DOM 树。

使用 css 包来进行 CSS 规则的解析，得到 AST。

#### 收集 CSS 规则
使用全局数组变量来存储规则，把 AST 得到的规则存入其中。

#### 调用规则
尽量早应用。最好是在 startTag 处理时就调用。
- 创建元素后，立即计算 CSS
- 假设在分析元素构建 DOM 元素时，CSS 规则已经收集完毕
- 真实浏览器中，可能遇到写在 body 中的 style 标签，需用重新 CSS 计算，这里忽略

#### 获取父元素序列
- 必须知道当前元素的所有父元素才能判断是否匹配 CSS 规则
- 由于 stack 存储所有正在处理的元素，所以从 stack 中 slice 获取即可
- 为高效匹配，先检查最后一个选择器，然后从内向外匹配父元素

#### 选择器与元素的匹配
暂不处理复杂的选择器。
首先判断当前元素和最后一个选择器是否匹配，然后再双循环选择器和父元素队列