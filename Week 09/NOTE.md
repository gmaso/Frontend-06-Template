# 第九周学习笔记

## HTML 解析
得到 HTML 主体后，进行解析得到 DOM。

使用状态机（FSM）进行解析。

### HTML 语法
查看 HTML 语言标准 Tokenization 章节，包含所有状态机需要的状态，一共有 80 多个。
Toy Browser 中主要实现 10 多个状态。

解析标签
- 开始标签
- 结束标签
- 自封闭标签

解析属性

#### Tokenization 词法分析



#### 用 token 构建 DOM 树：语法分析
- 从标签构建 DOM 树的基本技巧是使用栈
- 遇到考试标签时，创建元素并入栈，遇到结束标签时出栈
- 自封闭节点可视为入栈后立即出栈（其实就没入栈）
- 任何元素的父元素时它入栈前的栈顶

#### DOM 树添加文本节点
- 文本节点的处理与自封闭标签类似
- 多个连续的文本节点需要合并


## CSS 计算
生成带 CSS 属性的 DOM 树。

使用 css 包来进行 CSS 规则的解析，得到 AST。

#### 收集 CSS 规则
使用全局数组变量来存储规则，把 AST 得到的规则存入其中。

#### 调用规则
尽量早应用。最好是在 startTag 处理时就调用。
- 创建元素后，立即计算 CSS
- 假设在分析元素构建 DOM 元素时，CSS 规则已经收集完毕
- 真实浏览器中，可能遇到写在 body 中的 style 标签，需用重新 CSS 计算，这里忽略

#### 获取父元素序列
- 必须知道当前元素的所有父元素才能判断是否匹配 CSS 规则
- 由于 stack 存储所有正在处理的元素，所以从 stack 中 slice 获取即可
- 为高效匹配，先检查最后一个选择器，然后从内向外匹配父元素

#### 选择器与元素的匹配
暂不处理复杂的选择器。
首先判断当前元素和最后一个选择器是否匹配，然后再双循环选择器和父元素队列

#### 计算选择器与元素是否匹配
区分选择器类型。
- 标签选择器
- 类型选择器
- id 选择器
- 属性选择器（只处理 =、^=、*=、$= 四种值类型）
- 由以上四类构成的复合选择器
其它更复杂的选择器暂不考虑。


#### specificity 计算（特异性）
使用四元组表示，每个数字分布表示该类型的数量：
[0, 0, 0, 0]
inline id class tagName
比较两个四元组的时候，从高位往低位比较。 高位超过后就不需要比较低位了。

属性选择器与 class 选择器特异性一致。

### 20201228 优化属性解析，支持带空格的 class 属性，支持属性中包含字母外的其他符号
- 解析带单引号和双引号的属性值，只有等到匹配的引号时才结束。
- 属性名可以包含 - 和 :
- 属性值可以是数字
- 缓存特异性的值


### 用 Jest 测试单个函数
使用 Jest 测试 toSingles、match、calcSpecificity 三个函数。